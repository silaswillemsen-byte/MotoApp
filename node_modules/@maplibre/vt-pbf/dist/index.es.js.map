{"version":3,"file":"index.es.js","sources":["../lib/geojson_wrapper.ts","../index.ts"],"sourcesContent":["import Point from '@mapbox/point-geometry';\nimport type {TileFeature, AnyProps} from 'supercluster';\nimport {type Feature as GeoJSONVTFeature, Geometry} from 'geojson-vt';\nimport type {\n    VectorTileFeatureLike,\n    VectorTileLayerLike,\n    VectorTileLike,\n} from \"./types\";\n\nexport { VectorTileFeatureLike, VectorTileLayerLike, VectorTileLike };\n\nexport type Feature = TileFeature<AnyProps, AnyProps> | GeoJSONVTFeature;\n\nexport interface GeoJSONOptions {\n    version: number;\n    extent: number;\n}\n\nclass FeatureWrapper implements VectorTileFeatureLike {\n    feature: Feature;\n    type: VectorTileFeatureLike['type'];\n    properties: VectorTileFeatureLike['properties'];\n    id: VectorTileFeatureLike['id'];\n    extent: VectorTileFeatureLike['extent'];\n\n    constructor(feature: Feature, extent: number) {\n        this.feature = feature;\n        this.type = feature.type;\n        this.properties = feature.tags ? feature.tags : {};\n        this.extent = extent;\n\n        // If the feature has a top-level `id` property, copy it over, but only\n        // if it can be coerced to an integer, because this wrapper is used for\n        // serializing geojson feature data into vector tile PBF data, and the\n        // vector tile spec only supports integer values for feature ids --\n        // allowing non-integer values here results in a non-compliant PBF\n        // that causes an exception when it is parsed with vector-tile-js\n        if ('id' in feature) {\n            if (typeof feature.id === 'string') {\n                this.id = parseInt(feature.id, 10);\n            } else if (typeof feature.id === 'number' && !isNaN(feature.id as number)) {\n                this.id = feature.id;\n            }\n        }\n    }\n\n    loadGeometry() {\n        const geometry = [];\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const rawGeo = this.feature.type === 1 ? [this.feature.geometry] : this.feature.geometry as any as Geometry[][];\n        for (const ring of rawGeo) {\n            const newRing = [];\n            for (const point of ring) {\n                newRing.push(new Point(point[0], point[1]));\n            }\n            geometry.push(newRing);\n        }\n        return geometry;\n    }\n}\n\nexport const GEOJSON_TILE_LAYER_NAME = \"_geojsonTileLayer\";\n\nexport class GeoJSONWrapper implements VectorTileLayerLike {\n    layers: Record<string, VectorTileLayerLike>;\n    features: Feature[];\n    version: VectorTileLayerLike['version'];\n    name: VectorTileLayerLike['name'];\n    extent: VectorTileLayerLike['extent'];\n    length: VectorTileLayerLike['length'];\n\n    constructor(features: Feature[], options?: GeoJSONOptions) {\n        this.layers = { [GEOJSON_TILE_LAYER_NAME]: this };\n        this.name = GEOJSON_TILE_LAYER_NAME;\n        this.version = options ? options.version : 1;\n        this.extent = options ? options.extent : 4096;\n        this.length = features.length;\n        this.features = features;\n    }\n\n    feature(i: number): VectorTileFeatureLike {\n        return new FeatureWrapper(this.features[i], this.extent);\n    }\n}\n","import Pbf from 'pbf';\nimport {type Feature, GEOJSON_TILE_LAYER_NAME, type GeoJSONOptions, GeoJSONWrapper} from \"./lib/geojson_wrapper\";\nimport geojsonvt from 'geojson-vt';\nimport type {VectorTileFeatureLike, VectorTileLike, VectorTileLayerLike} from './lib/types';\n\ninterface Context {\n    keys: string[];\n    values: (string | boolean | number)[];\n    keycache: Record<string, number>;\n    valuecache: Record<string, number>;\n    feature?: VectorTileFeatureLike;\n}\n\n/**\n * Serialize a vector-tile-js-created tile to pbf\n *\n * @param tile\n * @return uncompressed, pbf-serialized tile data\n */\nexport function fromVectorTileJs(tile: VectorTileLike): Uint8Array {\n    const out = new Pbf();\n    writeTile(tile, out);\n    return out.finish();\n}\n\n/**\n * Serialized a geojson-vt-created tile to pbf.\n *\n * @param layers - An object mapping layer names to geojson-vt-created vector tile objects\n * @param options - An object specifying the vector-tile specification version and extent that were used to create `layers`.\n * @return uncompressed, pbf-serialized tile data\n */\nexport function fromGeojsonVt(layers: geojsonvt.Tile[], options?: GeoJSONOptions): Uint8Array {\n    const l: Record<string, VectorTileLayerLike> = {};\n    // eslint-disable-next-line @typescript-eslint/no-for-in-array\n    for (const k in layers) {\n        l[k] = new GeoJSONWrapper(layers[k].features, options);\n        l[k].name = k;\n        l[k].version = options ? options.version : 1;\n        l[k].extent = options ? options.extent : 4096;\n    }\n    return fromVectorTileJs({ layers: l });\n}\n\nfunction writeTile(tile: VectorTileLike, pbf: Pbf) {\n    for (const key in tile.layers) {\n        pbf.writeMessage(3, writeLayer, tile.layers[key]);\n    }\n}\n\nfunction writeLayer(layer: VectorTileLayerLike, pbf: Pbf) {\n    pbf.writeVarintField(15, layer.version || 1);\n    pbf.writeStringField(1, layer.name || '');\n    pbf.writeVarintField(5, layer.extent || 4096);\n\n    const context: Context = {\n        keys: [],\n        values: [],\n        keycache: {},\n        valuecache: {}\n    }\n\n    for (let i = 0; i < layer.length; i++) {\n        context.feature = layer.feature(i);\n        pbf.writeMessage(2, writeFeature, context);\n    }\n\n    const keys = context.keys;\n    for (const key of keys) {\n        pbf.writeStringField(3, key);\n    }\n\n    const values = context.values;\n    for (const value of values) {\n        pbf.writeMessage(4, writeValue, value);\n    }\n}\n\nfunction writeFeature(context: Context, pbf: Pbf) {\n    if (!context.feature) {\n        return;\n    }\n\n    const feature = context.feature;\n\n    if (feature.id !== undefined) {\n        pbf.writeVarintField(1, feature.id);\n    }\n\n    pbf.writeMessage(2, writeProperties, context);\n    pbf.writeVarintField(3, feature.type);\n    pbf.writeMessage(4, writeGeometry, feature);\n}\n\nfunction writeProperties(context: Context, pbf: Pbf) {\n    for (const key in context.feature?.properties) {\n        let value = context.feature.properties[key];\n\n        let keyIndex = context.keycache[key];\n        if (value == null) continue // don't encode null/undefined value properties\n\n        if (typeof keyIndex === 'undefined') {\n            context.keys.push(key);\n            keyIndex = context.keys.length - 1;\n            context.keycache[key] = keyIndex;\n        }\n        pbf.writeVarint(keyIndex);\n\n        if (typeof value !== 'string' && typeof value !== 'boolean' && typeof value !== 'number') {\n            value = JSON.stringify(value);\n        }\n        const valueKey = typeof value + ':' + value;\n        let valueIndex = context.valuecache[valueKey];\n        if (typeof valueIndex === 'undefined') {\n            context.values.push(value);\n            valueIndex = context.values.length - 1;\n            context.valuecache[valueKey] = valueIndex;\n        }\n        pbf.writeVarint(valueIndex);\n    }\n}\n\nfunction command(cmd: number, length: number) {\n    return (length << 3) + (cmd & 0x7);\n}\n\nfunction zigzag(num: number) {\n    return (num << 1) ^ (num >> 31);\n}\n\nfunction writeGeometry(feature: VectorTileFeatureLike, pbf: Pbf) {\n    const geometry = feature.loadGeometry();\n    const type = feature.type;\n    let x = 0;\n    let y = 0;\n\n    for (const ring of geometry) {\n        let count = 1;\n        if (type === 1) {\n            count = ring.length;\n        }\n        pbf.writeVarint(command(1, count)); // moveto\n        // do not write polygon closing path as lineto\n        const lineCount = type === 3 ? ring.length - 1 : ring.length;\n        for (let i = 0; i < lineCount; i++) {\n            if (i === 1 && type !== 1) {\n                pbf.writeVarint(command(2, lineCount - 1)); // lineto\n            }\n            const dx = ring[i].x - x;\n            const dy = ring[i].y - y;\n            pbf.writeVarint(zigzag(dx));\n            pbf.writeVarint(zigzag(dy));\n            x += dx;\n            y += dy;\n        }\n        if (feature.type === 3) {\n            pbf.writeVarint(command(7, 1)); // closepath\n        }\n    }\n}\n\nfunction writeValue(value: string | boolean | number, pbf: Pbf) {\n    const type = typeof value;\n    if (type === 'string') {\n        pbf.writeStringField(1, value as string);\n    } else if (type === 'boolean') {\n        pbf.writeBooleanField(7, value as boolean);\n    } else if (type === 'number') {\n        if (value as number % 1 !== 0) {\n            pbf.writeDoubleField(3, value as number);\n        } else if (value as number < 0) {\n            pbf.writeSVarintField(6, value as number);\n        } else {\n            pbf.writeVarintField(5, value as number);\n        }\n    }\n}\n\nexport {\n    GeoJSONWrapper,\n    GeoJSONOptions,\n    Feature,\n    GEOJSON_TILE_LAYER_NAME,\n    VectorTileFeatureLike,\n    VectorTileLike,\n    VectorTileLayerLike,\n};\n"],"names":["FeatureWrapper","constructor","feature","extent","this","type","properties","tags","id","parseInt","isNaN","loadGeometry","geometry","rawGeo","ring","newRing","point","push","Point","GEOJSON_TILE_LAYER_NAME","GeoJSONWrapper","features","options","layers","name","version","length","i","fromVectorTileJs","tile","out","Pbf","pbf","key","writeMessage","writeLayer","writeTile","finish","fromGeojsonVt","l","k","layer","writeVarintField","writeStringField","context","keys","values","keycache","valuecache","writeFeature","value","writeValue","undefined","writeProperties","writeGeometry","keyIndex","writeVarint","JSON","stringify","valueKey","valueIndex","command","cmd","zigzag","num","x","y","count","lineCount","dx","dy","writeBooleanField","writeDoubleField","writeSVarintField"],"mappings":"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"}